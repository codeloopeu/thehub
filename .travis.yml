matrix:
  include:
    - name: "Backend"
      language: java
      services:
        - docker
      env:
        global:
          - PGPORT=5432
          - GENERATE_SCHEMA=false
          - DOCKER_CACHE_FOLDER=$HOME/docker
      jdk:
        - oraclejdk8
      before_cache:
        - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
        - rm -f  $HOME/api/.gradle/caches/modules-2/modules-2.lock
        - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
        - rm -fr $HOME/api/.gradle/caches/*/plugin-resolution/
        - mkdir -p $HOME/docker
        - docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}' | xargs -n 2 -t sh -c 'test -e $HOME/docker/$1.tar.gz || docker save $0 | gzip -2 > $HOME/docker/$1.tar.gz'
      cache:
        directories:
          - $HOME/api/.gradle/caches/
          - $HOME/api/.gradle/wrapper/
          - ${DOCKER_CACHE_FOLDER}
      before_install:
        - sudo /etc/init.d/postgresql stop
        - if [[ -d ${DOCKER_CACHE_FOLDER} ]]; then ls ${DOCKER_CACHE_FOLDER}/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi
        - cd api/docker/
        - docker-compose up -d
        - cd ../../
      script:
        - cd api/
        - ./gradlew check
        - ./gradlew jacocoTestReport
        - ls -A $HOME/api/.gradle/caches
        - du -sh $HOME/api/.gradle/
        - ls -A $HOME/.gradle/caches
        - du -sh $HOME/.gradle/
    - name: "Frontend"
      language: node_js
      node_js:
        - "10.8.0"
      cache:
        directories:
          - ui/node_modules
      script:
        - cd ui/
        - yarn install
        - yarn eslint
        - yarn stylelint
        - yarn build
        - yarn test
after_success:
  - bash <(curl -s https://codecov.io/bash)
branches:
  only:
    - master
